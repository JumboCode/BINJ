<!DOCTYPE html>

<html>

    <head>
        <title>BINJ Map</title>
        <link rel="icon" type="img/png" href="favicon.png">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">

        <link rel="stylesheet" href="style.css"/>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
        <link rel="stylesheet" href="tags/bootstrap-tagsinput.css">
        <script src="tags/bootstrap-tagsinput.js"></script>

        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
        <script src="./test-data.js"></script>



        <script>
            $('#tags-input').tagsinput({
                confirmKeys: [13, 188]
            });
            $('#tags-input input').on('keypress', function(e){
                if (e.keyCode == 13){
                    e.keyCode = 188;
                    e.preventDefault();
                }
            });
            var tags = [];
            var changed = false;
            $(document).ready(function () {
                $('#form')
                    .find('[name="search"]')
                        .change(function (e) {
                            $('input').removeAttr('placeholder');
                            $('input').on('itemRemoved', function(event) {
                                var index = tags.indexOf(event.item);
                                if (index > -1) tags.splice(index, 1);
                                // event.item: contains the item
                                var filters = "map.html?filter=" + getFilters();
                                $("#iframe").attr("src", filters);

                            });
                            tags.push($("input").val());

                            var filters = "map.html" + getFilters();
                            $("#iframe").attr("src", filters);

                        })
                    .end();

            });
            function getFilters() {
                var str = "";
                for (var i = 0; i < tags.length; i++) {
                    if (tags[i] == "") tags.splice(i, 1);
                    str += tags[i] + "+";

                }

                //Getting filters from checked boxes
                $.each($("input:checked"), function() {
                    str += "+" + ($(this).val());
                });
                changed = true;
                if (str != "") return ("?filter=" + str.substring(0, str.length - 1));
                else return "";

            }

        </script>

    </head>

    <body>

        <div class=wrapper>
            <a href="/account/login" id="login">Log In</a>
        </div>
        <div class=logo>

            <img src="https://cdn-images-1.medium.com/max/246/1*SQumLd1QIKdVJAM5nfvuqA@2x.png" />
            <div id="title">
                <h1>
                    Boston Institute for Nonprofit Journalism
                </h1>
                <h4>
                    Reporting incubator and convener boosting independent media and journalists in Greater Boston
                </h4>
            </div>
        </div>

        <div id="content">
        <div id="map-list">

            <ul class="nav nav-tabs">
                <li class="active"><a data-toggle="tab" href="#map-view" id="activeTab">Filter</a></li>
                <li><a data-toggle="tab" href="#list-view">List</a></li>
            </ul>

            <div class="tab-content" id="tab-content">
                <div id="map-view" class="tab-pane fade in active">
                    <div id="filters">

                        <form id="form">
                        <input type="text" id= "search" name="search" placeholder="Search for tags..." data-role="tagsinput" value="">
                        </form>
                        <br>

                        <h3>Filter stories by...</h3>
                        <br>
                        <button type="button" class="btn btn-lg btn-info collapsed" data-toggle="collapse" data-target="#storytype">Story type</button>
                        <div id="storytype" class="collapse">
                        </div>
                        <hr />

                        <button type="button" class="btn btn-lg btn-info collapsed" data-toggle="collapse" data-target="#author">Author</button>
                        <div id="author" class="collapse">
                        </div>
                        <hr />
                    </div>
                </div>
                <div id="list-view" class="tab-pane fade in">
                    <h3>Active Stories</h3>
                    <p id="loading-message"></p>
                </div>
            </div>
          </div>
                <iframe id="iframe" src="map.html" width="100%" height="100%">
                </iframe>
        </div>

        <script>
            $('#content').height($(window).height() - $('.logo').height() - $('.wrapper').height());
            waitForData();

            function waitForData() {
                if (localStorage.getItem("storyData") !== null) {
                    loadCards(JSON.parse(localStorage.getItem("storyData")));
                    loadFilters(JSON.parse(localStorage.getItem("storyData")));

                } else {
                    setTimeout(waitForData, 250);
                }
            }

            function loadCards(data) {
                // this is to load the list view

                document.getElementById("loading-message").innerHTML = "";
                for (var i = 0; i < data.length; i++) {
                    var newCard = document.createElement("div");
                    newCard.className = "list-view-card";
                    // make a title
                    var title = document.createElement("h2")
                    title.innerHTML = data[i].title;
                    newCard.appendChild(title);
                    // make an author
                    var author = document.createElement("h4");
                    author.innerHTML = "By " + data[i].author;
                    newCard.appendChild(author);
                    // link to full text
                    var url = document.createElement("p");
                    url.innerHTML = '<a href="' + data[i].url + '">Full article</a>';
                    newCard.appendChild(url);
                    // make a blurb
                    var blurb = document.createElement("p");
                    blurb.innerHTML = data[i].blurb;
                    newCard.appendChild(blurb);
                    // maybe header photo?
                    document.getElementById("list-view").appendChild(newCard);
                }
            }

            function loadFilters(data) {
              var authors = [];
              var storytypes = [];
              // to load and show relevant filters
              document.getElementById("author").innerHTML = "";
              document.getElementById("storytype").innerHTML = "";
              for (var i = 0; i < data.length; i++) {
                  if (authors.includes(data[i].author)) {
                    // do nothing
                  } else {
                    // make author entry
                    var author = document.createElement("div");
                    author.className += "checkbox";
                    author.innerHTML = '<label><input type = "checkbox" value="' + data[i].author + '">' + data[i].author + '</label>';
                    document.getElementById("author").appendChild(author);
                    authors.push(data[i].author);
                  }
                  if (storytypes.includes(data[i].type)) {
                    // do nothing
                  } else {
                    // make type entry
                    var type = document.createElement("div");
                    type.className += "checkbox";
                    type.innerHTML = '<label><input type = "checkbox" value="' + data[i].type + '">' + data[i].type + '</label>';
                    document.getElementById("storytype").appendChild(type);
                    storytypes.push(data[i].type);
                  }
              }

            }
        </script>

    </body>

</html>
